<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תוכנית חילוץ - עונות השנה 5</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', sans-serif; }
        #overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: #ff3333;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #ff0000;
            pointer-events: none;
            max-width: 300px;
            z-index: 10;
        }
        .legend { margin-top: 10px; font-size: 13px; color: #fff; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .color-box { width: 15px; height: 15px; margin-left: 10px; border-radius: 2px; }
        #loading {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff0000; font-size: 24px; font-weight: bold;
            z-index: 20;
        }
        #controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #888;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            z-index: 10;
        }
    </style>
    <!-- שימוש ב-ES Module Shims לתמיכה רחבה בדפדפנים -->
    <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/"
        }
      }
    </script>
</head>
<body>
    <div id="loading">טוען נתוני מבנה...</div>
    <div id="overlay">
        <h2 style="margin:0 0 10px 0; font-size: 18px;">מבט רנטגן מבצעי</h2>
        <div style="font-size: 14px; color: #aaa;">עונות השנה 5, נס ציונה</div>
        <div class="legend">
            <div class="legend-item"><div class="color-box" style="background: #ff0000;"></div> ליבה: מדרגות מוגנות ומעלית</div>
            <div class="legend-item"><div class="color-box" style="background: #00ff00;"></div> כניסות/יציאות ראשיות</div>
            <div class="legend-item"><div class="color-box" style="background: #4444ff;"></div> מרפסות חילוץ</div>
            <div class="legend-item"><div class="color-box" style="background: #ffffff; opacity: 0.3;"></div> שלד קומות שקוף</div>
        </div>
    </div>
    <div id="controls-hint">סובב עם העכבר | זום עם הגלגלת | הזז עם קליק ימני</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // פונקציית אתחול הראשית
        function init() {
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(40, 30, 40);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // תאורה
            const light1 = new THREE.PointLight(0xffffff, 1);
            light1.position.set(50, 50, 50);
            scene.add(light1);
            const light2 = new THREE.AmbientLight(0x404040, 2);
            scene.add(light2);

            // חומרים
            const skeletonMat = new THREE.MeshPhongMaterial({ 
                color: 0xcccccc, transparent: true, opacity: 0.15 
            });
            const coreMat = new THREE.MeshPhongMaterial({ 
                color: 0xff0000, transparent: true, opacity: 0.7, emissive: 0x330000 
            });
            const exitMat = new THREE.MeshPhongMaterial({ 
                color: 0x00ff00, emissive: 0x002200 
            });
            const balconyMat = new THREE.MeshPhongMaterial({ 
                color: 0x4444ff, transparent: true, opacity: 0.5 
            });

            const buildingGroup = new THREE.Group();

            const floors = 7; 
            const floorH = 3.2;
            const bW = 18;
            const bD = 14;

            // 1. ליבה
            const coreGeo = new THREE.BoxGeometry(5, floors * floorH, 5);
            const core = new THREE.Mesh(coreGeo, coreMat);
            core.position.y = (floors * floorH) / 2;
            core.position.x = -2;
            buildingGroup.add(core);

            // 2. קומות ומרפסות
            for (let i = 0; i < floors; i++) {
                const floorGeo = new THREE.BoxGeometry(bW, 0.1, bD);
                const floorMesh = new THREE.Mesh(floorGeo, skeletonMat);
                floorMesh.position.y = i * floorH;
                buildingGroup.add(floorMesh);

                const balcGeo = new THREE.BoxGeometry(6, 0.2, 3);
                const balc = new THREE.Mesh(balcGeo, balconyMat);
                balc.position.set(5, i * floorH + 0.1, bD/2 + 1.5);
                buildingGroup.add(balc);
                
                const balcBack = new THREE.Mesh(balcGeo, balconyMat);
                balcBack.position.set(-4, i * floorH + 0.1, -bD/2 - 1.5);
                buildingGroup.add(balcBack);
            }

            // 3. מעטפת
            const shellGeo = new THREE.BoxGeometry(bW, floors * floorH, bD);
            const shell = new THREE.Mesh(shellGeo, new THREE.MeshPhongMaterial({
                color: 0xffffff, transparent: true, opacity: 0.05, side: THREE.DoubleSide
            }));
            shell.position.y = (floors * floorH) / 2;
            buildingGroup.add(shell);

            // 4. כניסות
            const mainEntry = new THREE.Mesh(new THREE.BoxGeometry(4, 3, 2), exitMat);
            mainEntry.position.set(0, 1.5, bD/2 + 0.5);
            buildingGroup.add(mainEntry);

            const emergencyExit = new THREE.Mesh(new THREE.BoxGeometry(2, 2.5, 2), exitMat);
            emergencyExit.position.set(-2, 1.25, -bD/2 - 0.5);
            buildingGroup.add(emergencyExit);

            // 5. סביבה
            const grid = new THREE.GridHelper(200, 50, 0x333333, 0x222222);
            scene.add(grid);

            scene.add(buildingGroup);

            // הסרת טעינה
            const loadingScreen = document.getElementById('loading');
            if (loadingScreen) loadingScreen.style.display = 'none';

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // הפעלה לאחר טעינת הדף
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
